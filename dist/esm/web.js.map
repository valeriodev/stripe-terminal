{"version":3,"file":"web.js","sourceRoot":"","sources":["../../src/web.ts"],"names":[],"mappings":"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","sourcesContent":["import { WebPlugin } from '@capacitor/core';\nimport type { ISdkManagedPaymentIntent } from '@stripe/terminal-js';\nimport { loadStripeTerminal } from '@stripe/terminal-js';\nimport type { DiscoverResult, ErrorResponse, Reader, Terminal } from '@stripe/terminal-js/types/terminal';\n\nimport { TerminalConnectTypes } from './definitions';\nimport type {\n  StripeTerminalPlugin,\n  ReaderInterface,\n  SimulateReaderUpdate,\n  SimulatedCardType,\n  Cart,\n} from './definitions';\nimport { TerminalEventsEnum } from './events.enum';\nimport {\n  convertReaderInterface,\n  mapFromCartToICart,\n  mapFromConnectionStatus,\n  mapFromPaymentStatus,\n} from './terminal-mappers';\n\nexport class StripeTerminalWeb extends WebPlugin implements StripeTerminalPlugin {\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  private stripeTerminal: Terminal | undefined = undefined;\n  private tokenProviderPromiseResolve: ((value: string) => void)[] = [];\n  private discoveredReaders: ReaderInterface[] = [];\n  private cachedFindReaders: Reader[] = [];\n  private cachedPaymentIntent: ISdkManagedPaymentIntent | undefined = undefined;\n  private isTest = false;\n\n  async initialize(options: { tokenProviderEndpoint: string; isTest: boolean }): Promise<void> {\n    if (this.stripeTerminal !== undefined) {\n      throw new Error('Stripe Terminal has already been initialized');\n    }\n\n    this.isTest = options.isTest;\n    const stripeTerminal = await loadStripeTerminal();\n    this.stripeTerminal = stripeTerminal?.create({\n      onFetchConnectionToken: async () => {\n        this.notifyListeners(TerminalEventsEnum.RequestedConnectionToken, null);\n        if (options.tokenProviderEndpoint) {\n          const response = await fetch(options.tokenProviderEndpoint, {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n            },\n          });\n          const data = await response.json();\n          return data.secret;\n        } else {\n          return new Promise<string>((resolve) => this.tokenProviderPromiseResolve.push(resolve));\n        }\n      },\n      onConnectionStatusChange: (status) => {\n        this.notifyListeners(TerminalEventsEnum.ConnectionStatusChange, {\n          status: mapFromConnectionStatus(status.status),\n        });\n      },\n      onPaymentStatusChange: (status) => {\n        this.notifyListeners(TerminalEventsEnum.PaymentStatusChange, {\n          status: mapFromPaymentStatus(status.status),\n        });\n      },\n      onUnexpectedReaderDisconnect: () => {\n        this.notifyListeners(TerminalEventsEnum.UnexpectedReaderDisconnect, {\n          reader: null,\n        });\n      },\n    });\n    this.notifyListeners(TerminalEventsEnum.Loaded, null);\n  }\n\n  async discoverReaders(options: { type: TerminalConnectTypes; locationId?: string }): Promise<{\n    readers: ReaderInterface[];\n  }> {\n    if (this.stripeTerminal === undefined) {\n      throw new Error('Stripe Terminal has not been initialized');\n    }\n\n    if (options.type !== TerminalConnectTypes.Internet) {\n      throw this.unavailable(`${options.type} is selected. Web platform is supported only internet connection.`);\n    }\n\n    const discoverResult = await this.stripeTerminal.discoverReaders({\n      simulated: this.isTest,\n      location: options.locationId,\n    });\n\n    if ((discoverResult as ErrorResponse).error) {\n      throw new Error((discoverResult as ErrorResponse).error.message);\n    }\n    this.cachedFindReaders = (discoverResult as DiscoverResult).discoveredReaders;\n    this.discoveredReaders = (discoverResult as DiscoverResult).discoveredReaders.map((reader) =>\n      convertReaderInterface(reader),\n    );\n    this.notifyListeners(TerminalEventsEnum.DiscoveredReaders, {\n      readers: this.discoveredReaders,\n    });\n\n    return {\n      readers: this.discoveredReaders,\n    };\n  }\n\n  /**\n   * This method is not supported in the web platform.\n   */\n  async cancelDiscoverReaders(): Promise<void> {\n    console.log('cancelDiscoverReaders');\n  }\n\n  async setConnectionToken(options: { token: string }): Promise<void> {\n    if (this.tokenProviderPromiseResolve.length === 0) {\n      return;\n    }\n    console.log('setConnectionToken', options);\n    const resolve = this.tokenProviderPromiseResolve.shift();\n    if (resolve === undefined) {\n      throw new Error('tokenProviderPromiseResolve is empty.');\n    }\n    resolve(options.token);\n  }\n\n  async setSimulatorConfiguration(options: {\n    update?: SimulateReaderUpdate | undefined;\n    simulatedCard?: SimulatedCardType | undefined;\n    simulatedTipAmount?: number | undefined;\n  }): Promise<void> {\n    console.log('setSimulatorConfiguration', options);\n  }\n\n  async connectReader(options: { reader: ReaderInterface }): Promise<void> {\n    const reader = this.cachedFindReaders.find((reader) => reader.serial_number === options.reader.serialNumber);\n    if (reader === undefined) {\n      throw new Error('reader is not match from descovered readers.');\n    }\n    const connectedResult = await this.stripeTerminal?.connectReader(reader);\n    if ((connectedResult as ErrorResponse).error) {\n      throw new Error((connectedResult as ErrorResponse).error.message);\n    }\n    this.notifyListeners(TerminalEventsEnum.ConnectedReader, null);\n  }\n\n  async getConnectedReader(): Promise<{ reader: ReaderInterface | null }> {\n    const reader = this.stripeTerminal?.getConnectedReader();\n    if (reader === undefined) {\n      return {\n        reader: null,\n      };\n    }\n    return {\n      reader: convertReaderInterface(reader),\n    };\n  }\n\n  async disconnectReader(): Promise<void> {\n    await this.stripeTerminal?.disconnectReader();\n    this.notifyListeners(TerminalEventsEnum.DisconnectedReader, null);\n  }\n\n  async collectPaymentMethod(options: { paymentIntent: string }): Promise<void> {\n    const collectResult = await this.stripeTerminal?.collectPaymentMethod(options.paymentIntent);\n\n    if ((collectResult as ErrorResponse).error) {\n      throw new Error((collectResult as ErrorResponse).error.message);\n    }\n\n    this.cachedPaymentIntent = (\n      collectResult as {\n        paymentIntent: ISdkManagedPaymentIntent;\n      }\n    ).paymentIntent;\n\n    this.notifyListeners(TerminalEventsEnum.CollectedPaymentIntent, null);\n  }\n\n  async cancelCollectPaymentMethod(): Promise<void> {\n    await this.stripeTerminal?.cancelCollectPaymentMethod();\n    this.notifyListeners(TerminalEventsEnum.Canceled, null);\n  }\n\n  async confirmPaymentIntent(): Promise<void> {\n    if (this.cachedPaymentIntent === undefined) {\n      throw new Error('PaymentIntent is not cached.');\n    }\n    const processResult = await this.stripeTerminal?.processPayment(this.cachedPaymentIntent);\n    if ((processResult as ErrorResponse).error) {\n      throw new Error((processResult as ErrorResponse).error.message);\n    }\n    console.log(\"Confirm payment\",processResult);\n    this.notifyListeners(TerminalEventsEnum.ConfirmedPaymentIntent, processResult);\n  }\n\n  async installAvailableUpdate(): Promise<void> {\n    console.log('installAvailableUpdate');\n  }\n  async cancelInstallUpdate(): Promise<void> {\n    console.log('cancelInstallUpdate');\n  }\n  async setReaderDisplay(options: Cart): Promise<void> {\n    await this.stripeTerminal?.setReaderDisplay({\n      type: 'cart',\n      cart: mapFromCartToICart(options),\n    });\n    console.log('setReaderDisplay', options);\n  }\n  async clearReaderDisplay(): Promise<void> {\n    await this.stripeTerminal?.clearReaderDisplay();\n  }\n  async rebootReader(): Promise<void> {\n    console.log('rebootReader');\n  }\n  async cancelReaderReconnection(): Promise<void> {\n    console.log('cancelReaderReconnection');\n  }\n\n  collect = 'deprecated';\n  cancelCollect = 'deprecated';\n}\n"]}